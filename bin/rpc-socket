#!/usr/bin/env node


var fs = require('fs')
var utils = require('./lib/utils')
var Master = require('./lib/master')
var Rpc = require('./lib/rpc')
var Slave = require('./lib/slave')
var Io = require('./lib/io')
var logger = utils.logger;
//

var args = process.argv;
//
args.shift()
args.shift()

//
var config = {

}
//
for(var i = args.length - 1; i >= 0; i--) {
	var arg = args[i].split('=')
	var key = arg[0]
	var val = arg[1]
	if(key === '-config') {
		config['config'] = val
	}
};
//
if(!(config['config'])) {
	throw '  ERROR: Should be something like: node app -config=/path/to/config.json'
}
//
fs.readFile(config['config'], function(err, data) {
	if(err)
		throw '  ERROR: No such file: '+config['config']+' Should be something like: node app -config=/path/to/config.json';
	//
	config = JSON.parse(data)
	//
	var type = config['type']
	var port = config['port']
	var host = config['host']
	var modules = config['modules']
	var baseDir = config['baseDir']
	//
	//
	for(var i = modules.length - 1; i >= 0; i--) {
		modules[i] = baseDir + '/' + modules[i]
	};
	//
	if(type === 'master') {
		new Master(port, host, modules)
	} else if(type === 'slave') {
		new Slave(port, host, modules)
	} else if(type === 'io') {
		new Io(port, host, modules)
	}
});
